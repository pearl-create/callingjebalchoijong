<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²° (ì‹œê° ê²½ê³ íŒ, ë°°ê²½ ì†ŒìŒ ì˜ˆì™¸)</title>

  <!-- TFJS + Speech Commands -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.5.4/dist/speech-commands.min.js"></script>

  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#0b1020;color:#e6ecff;margin:0;transition:box-shadow 0.3s ease;}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px}
    p{margin:4px 0 18px;color:#93a0c3}
    .video-area{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}
    .video-box{flex:1 1 45%;background:#12182c;border:1px solid #22315c;border-radius:16px;
      padding:12px;text-align:center}
    video{width:100%;max-width:420px;border-radius:12px;background:#000}
    button{padding:10px 16px;border-radius:12px;border:1px solid #22315c;background:#1a2347;
      color:#e6ecff;cursor:pointer}
    button:hover{background:#22315c}
    .meter{margin-top:16px;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .bar{height:12px;background:#202a52;border-radius:999px;overflow:hidden;border:1px solid #2a3766}
    .bar>i{display:block;height:100%;width:0%}
    .warn-toast{
      position:fixed; top:16px; right:16px; z-index:9999;
      background:#ff4d4f; color:#fff; padding:12px 16px;
      border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.35);
      font-weight:600; letter-spacing:.2px; display:none;
    }
    .flash-border{
      box-shadow:0 0 0 6px rgba(255, 77, 79, 0.8);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¥ ë‹¤ê° - ê²°</h1>
    <p>ë©˜í† , ë©˜í‹°ì™€ ì¦ê±°ìš´ ì‹œê°„ ë˜ì‹œê¸° ë°”ëë‹ˆë‹¤!.</p>
    <button id="start">ì‹œì‘í•˜ê¸°</button>

    <div class="video-area">
      <div class="video-box">
        <h3>ë‚˜</h3>
        <video id="cam" autoplay playsinline muted></video>
      </div>

      <div class="video-box">
        <h3>ìƒëŒ€ë°©</h3>
        <video id="peer" autoplay loop muted>
          <source src="https://cdn.pixabay.com/vimeo/406999325/people-34653.mp4?width=640" type="video/mp4">
          ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </video>
      </div>
    </div>

    <div id="labels" class="meter"></div>
    <div id="log" style="margin-top:12px;color:#9fe2ff"></div>
  </div>

  <div id="warn" class="warn-toast">âš ï¸ ê²½ê³ : ë¹„ì†ì–´ ê°ì§€!</div>

<script>
const MODEL_URL = "./model/";
let recognizer, labels=[], listening=false;
const startBtn=document.getElementById('start');
const logEl=document.getElementById('log');
const labelsEl=document.getElementById('labels');
const warnEl=document.getElementById('warn');
const bodyEl=document.body;

const THRESHOLD = 0.80;
let lastAlertAt = 0;
const ALERT_COOLDOWN = 1500;
const IGNORE_LABELS = ["ë°°ê²½ ì†ŒìŒ", "background noise"]; // ğŸš« ê²½ê³  ì œì™¸ ëŒ€ìƒ

function buildMeters(){
  labelsEl.innerHTML='';
  labels.forEach(name=>{
    const row=document.createElement('div'); row.className='row';
    const lab=document.createElement('b'); lab.textContent=name;
    const val=document.createElement('span'); val.textContent='0.00';
    const bar=document.createElement('div'); bar.className='bar';
    const fill=document.createElement('i'); bar.appendChild(fill);
    row.appendChild(lab); row.appendChild(val); row.appendChild(bar);
    labelsEl.appendChild(row);
    row._refs={val,fill};
  });
}

async function init(){
  try{
    logEl.textContent='ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
    document.getElementById('cam').srcObject = stream;

    const MODEL_DIR = new URL(MODEL_URL, window.location.href).href;
    const MODEL_JSON_URL = new URL("model.json", MODEL_DIR).href;
    const METADATA_URL  = new URL("metadata.json", MODEL_DIR).href;

    recognizer = speechCommands.create('BROWSER_FFT', undefined, MODEL_JSON_URL, METADATA_URL);
    await recognizer.ensureModelLoaded();
    labels = recognizer.wordLabels();
    buildMeters();
    logEl.textContent='ê°ì§€ ì‹œì‘...';
    startListening();
  }catch(e){
    console.error(e);
    logEl.textContent='ì˜¤ë¥˜: '+(e && e.message ? e.message : e);
  }
}

function flashBorder(){
  bodyEl.classList.add('flash-border');
  warnEl.style.display='block';
  setTimeout(()=>{
    bodyEl.classList.remove('flash-border');
    warnEl.style.display='none';
  }, 1000);
}

function updateMeters(scores){
  const rows=labelsEl.querySelectorAll('.row');
  let bestIdx=0, bestVal=-1;
  for(let i=0;i<scores.length;i++){
    const row=rows[i]; if(!row || !row._refs) continue;
    const prob = scores[i];
    row._refs.val.textContent = prob.toFixed(2);
    row._refs.fill.style.width = Math.max(0, Math.min(100, prob*100))+'%';
    if(prob>bestVal){bestVal=prob; bestIdx=i;}
  }
  const bestLabel = labels[bestIdx];
  logEl.textContent = `${bestLabel} : ${(bestVal*100).toFixed(1)}%`;

  // ğŸš¨ ì„ê³„ì¹˜ ì´ˆê³¼ + ì˜ˆì™¸ ì•„ë‹Œ ê²½ìš°ë§Œ ê²½ê³ 
  const now = Date.now();
  const isIgnored = IGNORE_LABELS.some(l => bestLabel.includes(l));
  if(bestVal >= THRESHOLD && !isIgnored && now - lastAlertAt > ALERT_COOLDOWN){
    lastAlertAt = now;
    warnEl.textContent = `âš ï¸ ê²½ê³ : '${bestLabel}' í™•ë¥  ${(bestVal*100).toFixed(1)}%`;
    flashBorder();
  }
}

function startListening(){
  if(listening) return; listening=true;
  recognizer.listen(result=>{
    const scores=result.scores;
    updateMeters(scores);
  }, {includeSpectrogram:true, overlapFactor:0.5});
}

startBtn.addEventListener('click', init);
</script>
</body>
</html>
